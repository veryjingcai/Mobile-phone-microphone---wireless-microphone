<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Win11 WiFi 扩展话筒</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <style>
        /* Win11 Acrylic/Mica effect simulation */
        body {
            background: radial-gradient(circle at 50% 0%, #2c3e50, #000000);
            color: #ffffff;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .glass-panel {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }
        .btn-primary {
            background: linear-gradient(135deg, #0078d4, #005a9e);
            transition: all 0.2s ease;
        }
        .btn-primary:hover {
            filter: brightness(1.1);
            transform: translateY(-1px);
        }
        .btn-primary:active {
            transform: translateY(0);
        }
        textarea {
            font-family: monospace;
            font-size: 0.8rem;
        }
        
        /* Audio Visualizer Animation */
        .bar-container {
            display: flex;
            justify-content: center;
            align-items: flex-end;
            height: 60px;
            gap: 4px;
        }
        .bar {
            width: 6px;
            background: #00d4ff;
            border-radius: 4px;
            height: 5px;
            transition: height 0.1s ease;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4 selection:bg-blue-500 selection:text-white">

    <!-- Main Container -->
    <main class="glass-panel w-full max-w-2xl rounded-2xl p-6 md:p-10 relative overflow-hidden">
        
        <!-- Header -->
        <header class="text-center mb-8">
            <div class="inline-block p-3 rounded-full bg-blue-500/20 mb-4">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                </svg>
            </div>
            <h1 class="text-3xl font-bold mb-2">WiFi 扩展话筒</h1>
            <p class="text-gray-400 text-sm">将手机变成 Windows 11 的无线麦克风</p>
        </header>

        <!-- Step 1: Role Selection -->
        <div id="step-selection" class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <button onclick="app.initSender()" class="glass-panel hover:bg-white/10 p-6 rounded-xl text-left transition group cursor-pointer">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-semibold group-hover:text-blue-300">我是手机</h3>
                    <span class="bg-blue-500/20 text-blue-300 text-xs px-2 py-1 rounded">发送端</span>
                </div>
                <p class="text-gray-400 text-sm">捕捉麦克风声音并发送给电脑。</p>
            </button>

            <button onclick="app.initReceiver()" class="glass-panel hover:bg-white/10 p-6 rounded-xl text-left transition group cursor-pointer">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-semibold group-hover:text-green-300">我是电脑</h3>
                    <span class="bg-green-500/20 text-green-300 text-xs px-2 py-1 rounded">接收端</span>
                </div>
                <p class="text-gray-400 text-sm">接收声音并播放 (需配合虚拟声卡使用)。</p>
            </button>
        </div>

        <!-- Sender Interface (Phone) -->
        <div id="sender-ui" class="hidden space-y-6">
            <div class="text-center">
                <div class="text-emerald-400 font-medium mb-2 flex items-center justify-center gap-2">
                    <span class="w-2 h-2 bg-emerald-400 rounded-full animate-pulse"></span>
                    正在捕捉音频
                </div>
                <div class="bar-container" id="sender-visualizer">
                    <!-- Bars generated by JS -->
                </div>
            </div>

            <div class="space-y-4 border-t border-white/10 pt-6">
                <h3 class="text-lg font-medium">连接步骤 (无需服务器)</h3>
                
                <div id="sender-step-1">
                    <p class="text-sm text-gray-400 mb-2">1. 复制下方的 <span class="text-blue-300">连接代码 A</span> 发送给电脑：</p>
                    <div class="relative">
                        <textarea id="sender-offer" readonly class="w-full bg-black/30 border border-white/10 rounded p-3 h-24 focus:outline-none focus:border-blue-500 text-xs resize-none" placeholder="正在生成代码...请稍候"></textarea>
                        <button onclick="app.copyToClipboard('sender-offer')" class="absolute top-2 right-2 bg-white/10 hover:bg-white/20 text-xs px-2 py-1 rounded">复制</button>
                    </div>
                </div>

                <div id="sender-step-2" class="opacity-50 pointer-events-none transition-opacity">
                    <p class="text-sm text-gray-400 mb-2">3. 将电脑生成的 <span class="text-green-300">连接代码 B</span> 粘贴到这里：</p>
                    <textarea id="sender-answer-input" class="w-full bg-black/30 border border-white/10 rounded p-3 h-24 focus:outline-none focus:border-blue-500 text-xs resize-none" placeholder="在此粘贴电脑的代码..."></textarea>
                    <button onclick="app.finalizeSenderConnection()" class="mt-3 btn-primary w-full py-3 rounded-lg font-medium">连接电脑</button>
                </div>
            </div>
        </div>

        <!-- Receiver Interface (PC) -->
        <div id="receiver-ui" class="hidden space-y-6">
            <div class="bg-yellow-500/10 border border-yellow-500/20 p-4 rounded-lg mb-4">
                <h4 class="text-yellow-400 text-sm font-bold mb-1">⚠️ 关键设置提示</h4>
                <p class="text-gray-300 text-xs">
                    本网页会播放手机的声音。要让它成为系统麦克风(用于QQ/会议等)，请安装 <strong>VB-Audio Cable</strong>，并在系统设置中将浏览器输出设为 "CABLE Input"，将会议软件输入设为 "CABLE Output"。
                </p>
            </div>

            <div class="space-y-4">
                <div id="receiver-step-1">
                    <p class="text-sm text-gray-400 mb-2">2. 将手机的 <span class="text-blue-300">连接代码 A</span> 粘贴到这里：</p>
                    <textarea id="receiver-offer-input" class="w-full bg-black/30 border border-white/10 rounded p-3 h-24 focus:outline-none focus:border-blue-500 text-xs resize-none" placeholder="在此粘贴手机的代码..."></textarea>
                    <button onclick="app.createReceiverAnswer()" class="mt-2 btn-primary w-full py-2 rounded-lg font-medium text-sm">生成代码 B</button>
                </div>

                <div id="receiver-step-2" class="hidden">
                    <p class="text-sm text-gray-400 mb-2">3. 复制下方的 <span class="text-green-300">连接代码 B</span> 发回给手机：</p>
                    <div class="relative">
                        <textarea id="receiver-answer" readonly class="w-full bg-black/30 border border-white/10 rounded p-3 h-24 focus:outline-none focus:border-blue-500 text-xs resize-none"></textarea>
                        <button onclick="app.copyToClipboard('receiver-answer')" class="absolute top-2 right-2 bg-white/10 hover:bg-white/20 text-xs px-2 py-1 rounded">复制</button>
                    </div>
                    <div class="mt-4 text-center text-emerald-400 animate-pulse text-sm">
                        等待手机确认连接...
                    </div>
                </div>
                
                <div id="receiver-connected" class="hidden text-center pt-6">
                    <div class="w-16 h-16 bg-emerald-500/20 rounded-full flex items-center justify-center mx-auto mb-3">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-emerald-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                        </svg>
                    </div>
                    <h3 class="text-xl font-bold text-white">已连接</h3>
                    <p class="text-sm text-gray-400 mt-1">正在接收手机音频...</p>
                    <div class="bar-container mt-4" id="receiver-visualizer">
                        <!-- Bars -->
                    </div>
                    <button onclick="app.resumeAudio()" class="mt-4 text-xs text-blue-400 hover:underline">没声音？点击这里激活音频</button>
                </div>
            </div>
        </div>

        <!-- Troubleshooting / Help Section -->
        <div id="https-warning" class="hidden mt-6 p-4 bg-red-500/20 border border-red-500/30 rounded-lg text-left">
            <h4 class="font-bold text-red-300 flex items-center gap-2 mb-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                麦克风无法启动？
            </h4>
            <p class="text-sm text-gray-300 mb-2">
                浏览器出现 <code>Cannot read properties of undefined (reading 'getUserMedia')</code> 错误，是因为<strong>浏览器安全策略</strong>。
            </p>
            <p class="text-xs text-gray-400 mb-3">
                现代浏览器（Chrome, Safari, Edge）<strong>强制要求 HTTPS</strong> 才能调用麦克风。如果你是通过局域网 IP (如 http://192.168.1.5) 访问，麦克风会被禁用。
            </p>
            <div class="text-xs text-gray-300 space-y-2">
                <p><strong>解决方案 1 (推荐 - 部署上线):</strong><br>将此 HTML 文件上传到 <strong>GitHub Pages, Vercel, 或 Netlify</strong> 等免费 HTTPS 托管平台，然后用手机访问生成的 https 网址。</p>
                <p><strong>解决方案 2 (安卓 Chrome 调试):</strong><br>在手机 Chrome 地址栏输入 <code>chrome://flags/#unsafely-treat-insecure-origin-as-secure</code>，开启该选项，并在下方的文本框填入电脑的 IP 地址 (如 http://192.168.1.x:端口)，然后重启浏览器。</p>
            </div>
        </div>

        <!-- Footer -->
        <div class="mt-8 pt-4 border-t border-white/5 text-center">
             <button onclick="location.reload()" class="text-xs text-gray-500 hover:text-gray-300 transition">重置 / 断开连接</button>
        </div>

    </main>

    <script>
        /**
         * Win11 WiFi Microphone Logic
         * Uses WebRTC for peer-to-peer audio streaming.
         * Uses Manual Signaling (Copy/Paste SDP) to avoid backend server requirement.
         */
        class MicApp {
            constructor() {
                this.peerConnection = null;
                this.localStream = null;
                this.audioContext = null;
                this.analyser = null;
                this.dataChannel = null;
                
                // WebRTC Configuration (STUN servers for WAN, though local network often works without)
                this.rtcConfig = {
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' }
                    ]
                };

                this.visualizerBars = 10;
            }

            // --- UI Helpers ---
            show(id) { document.getElementById(id).classList.remove('hidden'); }
            hide(id) { document.getElementById(id).classList.add('hidden'); }
            
            async copyToClipboard(elementId) {
                const el = document.getElementById(elementId);
                el.select();
                try {
                    await navigator.clipboard.writeText(el.value);
                    const btn = el.parentElement.querySelector('button');
                    const originalText = btn.innerText;
                    btn.innerText = "已复制!";
                    setTimeout(() => btn.innerText = originalText, 2000);
                } catch (err) {
                    alert("复制失败，请手动复制");
                }
            }

            initVisualizer(containerId, sourceStream) {
                if (!this.audioContext) {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                
                // Connect stream to analyser
                const source = this.audioContext.createMediaStreamSource(sourceStream);
                this.analyser = this.audioContext.createAnalyser();
                this.analyser.fftSize = 64;
                source.connect(this.analyser);

                // Generate DOM bars
                const container = document.getElementById(containerId);
                container.innerHTML = '';
                for(let i=0; i<this.visualizerBars; i++) {
                    const bar = document.createElement('div');
                    bar.className = 'bar';
                    container.appendChild(bar);
                }

                const bufferLength = this.analyser.frequencyBinCount;
                const dataArray = new Uint8Array(bufferLength);
                const bars = container.querySelectorAll('.bar');

                const draw = () => {
                    requestAnimationFrame(draw);
                    this.analyser.getByteFrequencyData(dataArray);
                    
                    // Simple visualization logic
                    for(let i=0; i<this.visualizerBars; i++) {
                        // Map bars to frequency roughly
                        const index = Math.floor(i * (bufferLength / this.visualizerBars));
                        const value = dataArray[index];
                        const percent = Math.max(10, (value / 255) * 100);
                        bars[i].style.height = percent + '%';
                        
                        // Color reaction
                        if (value > 200) bars[i].style.backgroundColor = '#ff4d4d';
                        else bars[i].style.backgroundColor = '#00d4ff';
                    }
                };
                draw();
            }

            // --- Sender Logic (Phone) ---
            async initSender() {
                this.hide('step-selection');
                this.show('sender-ui');

                try {
                    // 1. Get Microphone
                    // Security Check: getUserMedia is only available in Secure Contexts (HTTPS or localhost)
                    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                        // Show the help guide explicitly
                        this.show('https-warning');
                        throw new Error("浏览器禁止非 HTTPS 网页访问麦克风。请查看下方的红色帮助区域。");
                    }

                    this.localStream = await navigator.mediaDevices.getUserMedia({ 
                        audio: { 
                            echoCancellation: false, 
                            noiseSuppression: true, 
                            autoGainControl: true 
                        }, 
                        video: false 
                    });

                    // 2. Start Visualizer
                    this.initVisualizer('sender-visualizer', this.localStream);

                    // 3. Create Peer Connection
                    this.peerConnection = new RTCPeerConnection(this.rtcConfig);
                    
                    // Add tracks
                    this.localStream.getTracks().forEach(track => {
                        this.peerConnection.addTrack(track, this.localStream);
                    });

                    // Create Data Channel (required to establish connection even if audio fails initially)
                    this.dataChannel = this.peerConnection.createDataChannel("chat");

                    // 4. Create Offer
                    const offer = await this.peerConnection.createOffer();
                    await this.peerConnection.setLocalDescription(offer);

                    // 5. Wait for ICE Gathering to complete (so we get one single blob to copy)
                    this.peerConnection.onicecandidate = (event) => {
                        if (event.candidate === null) {
                            // Gathering finished
                            const code = btoa(JSON.stringify(this.peerConnection.localDescription));
                            document.getElementById('sender-offer').value = code;
                            
                            // Enable Step 2
                            document.getElementById('sender-step-2').classList.remove('opacity-50', 'pointer-events-none');
                        }
                    };

                } catch (err) {
                    alert("无法访问麦克风: " + err.message);
                    location.reload();
                }
            }

            async finalizeSenderConnection() {
                const answerStr = document.getElementById('sender-answer-input').value.trim();
                if (!answerStr) return alert("请粘贴电脑的代码 B");

                try {
                    const answerDesc = JSON.parse(atob(answerStr));
                    await this.peerConnection.setRemoteDescription(new RTCSessionDescription(answerDesc));
                    alert("连接成功！您的手机现在是麦克风了。");
                } catch (e) {
                    alert("连接代码无效，请检查。");
                }
            }

            // --- Receiver Logic (PC) ---
            initReceiver() {
                this.hide('step-selection');
                this.show('receiver-ui');
                
                this.peerConnection = new RTCPeerConnection(this.rtcConfig);

                // Handle incoming stream
                this.peerConnection.ontrack = (event) => {
                    const remoteStream = event.streams[0];
                    const audio = new Audio();
                    audio.srcObject = remoteStream;
                    audio.play();
                    
                    this.hide('receiver-step-1');
                    this.hide('receiver-step-2');
                    this.show('receiver-connected');

                    this.initVisualizer('receiver-visualizer', remoteStream);
                };
            }

            async createReceiverAnswer() {
                const offerStr = document.getElementById('receiver-offer-input').value.trim();
                if (!offerStr) return alert("请粘贴手机的代码 A");

                try {
                    const offerDesc = JSON.parse(atob(offerStr));
                    await this.peerConnection.setRemoteDescription(new RTCSessionDescription(offerDesc));

                    const answer = await this.peerConnection.createAnswer();
                    await this.peerConnection.setLocalDescription(answer);

                    // Wait for ICE
                    this.peerConnection.onicecandidate = (event) => {
                        if (event.candidate === null) {
                            const code = btoa(JSON.stringify(this.peerConnection.localDescription));
                            document.getElementById('receiver-answer').value = code;
                            
                            this.hide('receiver-step-1');
                            this.show('receiver-step-2');
                        }
                    };

                } catch (e) {
                    alert("代码无效: " + e.message);
                }
            }
            
            // Helper for autoplay policy blocks
            resumeAudio() {
                if(this.audioContext && this.audioContext.state === 'suspended') {
                    this.audioContext.resume();
                }
            }
        }

        // Initialize
        const app = new MicApp();
    </script>
</body>
</html>